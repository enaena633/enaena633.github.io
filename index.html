<head>
  <!-- Load d3 source scripts -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <!-- <script src="https://d3js.org/d3.v6.min.js" type="text/JavaScript"></script> -->
  <script src="https://d3js.org/colorbrewer.v1.min.js"></script>

  <!-- style section-->
  <style>
    .axis path {
      stroke: black;
      stroke-width: 2px;
    }

    .axis line {
      stroke: black;
      stroke-width: 1.5px;
    }

    .axis text {
      fill: black;
      font-weight: bold;
      font-size: 14px;
      font-family: "Arial Black", Gadget, sans-serif;
    }

    .legend text {
      fill: black;
      font-family: "Arial Black", Gadget, sans-serif;
    }

    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    #vaccination {
      align-self: flex-end;
    }

    #covid_cases {
      align-self: center;
    }

    #image {
      align-self: flex-start;
      width: 500px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="vaccination"></div>
    <div id="covid_cases"></div>
    <img id="image"></img>
  </div>
</body>

<script>
  const margin = { top: 50, right: 20, bottom: 30, left: 30 };

  const width1 = 700 - margin.left - margin.right;
  const height1 = 500 - margin.top - margin.bottom;

  //chart 1 - total covid cases worldwide
  // append the svg object to the body of the page
  const svg = d3
    .select("#covid_cases")
    .append("svg")
    .attr("width", width1 + margin.left + margin.right)
    .attr("height", height1 + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  d3.csv("clean_data_total_cases.csv", function (data) {
    const sumstat = d3
      .nest() // nest function allows to group the calculation per level of a factor
      .key(function (d) {
        return d.location;
      })
      .entries(data);

    // Add X axis
    const x = d3
      .scaleTime()
      .domain(
        d3.extent(data, function (d) {
          return new Date(d.date);
        })
      )
      .range([0, width1]);
    svg
      .append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height1 + ")")
      .call(d3.axisBottom(x).ticks(10))
      .append("text")
      .attr("x", (width1 + margin.left) / 2) //middle of the xAxis
      .attr("y", margin.bottom) //middle of the xAxis
      .attr("text-anchor", "end")
      .text("Year");

    // Add Y axis
    const y = d3
      .scaleLinear()
      .domain([
        0,
        d3.max(data, function (d) {
          return Number(parseFloat(d.total_cases).toFixed(20));
        }),
      ])
      .range([height1, 0]);
    svg
      .append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y))
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .attr("text-anchor", "end")
      .text("Natural Log of Total Covid Cases");

    // color palette
    var res = sumstat.map(function (d) {
      return d.key;
    }); // list of group names
    var color = d3
      .scaleOrdinal()
      .domain(res)
      .range([
        "#e41a1c",
        "#377eb8",
        "#4daf4a",
        "#984ea3",
        "#ff7f00",
        "#ffff33",
        "#a65628",
        "#f781bf",
      ]);

    // Draw the line
    svg
      .selectAll(".line")
      .data(sumstat)
      .enter()
      .append("path")
      .attr("fill", "none")
      .attr("stroke", function (d) {
        return color(d.key);
      })
      .attr("stroke-width", 1.5)
      .attr("d", function (d) {
        return d3
          .line()
          .x(function (d) {
            return x(new Date(d.date));
          })
          .y(function (d) {
            return y(Number(parseFloat(d.total_cases).toFixed(20)));
          })(d.values);
      })
      .on("mouseover", (d2) => {
        console.log(d2);
        // --- HOVER EFFECT HERE ---

        // Images
        if (d2.key === "Singapore") {
          document.getElementById("image").src = "Images/pic_Singapore_covid.jpeg";
        } else if (d2.key === "China") {
          document.getElementById("image").src = "Images/pic_China_covid.jpeg";
        } else if (d2.key === "Japan") {
          document.getElementById("image").src = "Images/pic_Japan_covid.jpeg";
        } else if (d2.key === "Australia") {
          document.getElementById("image").src = "Images/pic_Australia_covid.jpeg";
        } else if (d2.key === "Italy") {
          document.getElementById("image").src = "Images/pic_Italy_covid.jpeg";
        } else if (d2.key === "Canada") {
          document.getElementById("image").src = "Images/pic_Canada_covid.jpeg";
        } else if (d2.key === "United States") {
          document.getElementById("image").src = "Images/pic_US_covid.jpeg";
        } else if (d2.key === "United Kingdom") {
          document.getElementById("image").src = "Images/pic_UK_covid.jpeg";
        }

        // chart 2 - people_fully_vaccinated_per_hundred
        d3.selectAll("#vaccination *").remove(); 
        
        const width2 = 1200 - margin.left - margin.right - width1;
        const height2 = 750 - margin.top - margin.bottom - height1;

        const chart = d3
          .select("#vaccination")
          .append("svg")
          .attr("width", width2 + margin.left + margin.right)
          .attr("height", height2 + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        d3.csv("clean_data_full_vaccination.csv", function (data) {
          const sumstat = d3
            .nest() // nest function allows to group the calculation per level of a factor
            .key(function (d) {
              return d.location;
            })
            .entries(data);

          // Add X axis
          const x = d3
            .scaleTime()
            .domain(
              d3.extent(data, function (d) {
                return new Date(d.date);
              })
            )
            .range([0, width2]);
          chart
            .append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + height2 + ")")
            .call(d3.axisBottom(x).ticks(10))
            .append("text")
            .attr("x", (width2 + margin.left) / 2) //middle of the xAxis
            .attr("y", margin.bottom) //middle of the xAxis
            .attr("text-anchor", "end")
            .text("Year");

          // Add Y axis
          const y = d3
            .scaleLinear()
            .domain([
              0,
              d3.max(data, function (d) {
                return Number(
                  parseFloat(d.people_fully_vaccinated_per_hundred).toFixed(20)
                );
              }),
            ])
            .range([height2, 0]);
          chart
            .append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .attr("text-anchor", "end")
            .text("Natural Log of Total Covid Cases");

          // color palette
          var res = sumstat.map(function (d) {
            return d.key;
          }); // list of group names
          var color = d3.scaleOrdinal().domain(res).range([
            //   "#e41a1c",
            "#377eb8",
            //   "#4daf4a",
            "#984ea3",
            "#ff7f00",
            "#ffff33",
            "#a65628",
            "#f781bf",
          ]);

          // Draw the line
          chart
            .selectAll(".line")
            .data(sumstat)
            .enter()
            .append("path")
            .attr("fill", "none")
            .attr("stroke", function (d) {
              return color(d.key);
            })
            .attr("stroke-width", 1.5)
            .attr("d", function (d) {

              // --- ONLY RENDER SECOND GRAPH WHERE KEY MATCHES ---
              if (d.key === d2.key) {
                return d3
                  .line()
                  .x(function (d) {
                    return x(new Date(d.date));
                  })
                  .y(function (d) {
                    return y(
                      Number(
                        parseFloat(
                          d.people_fully_vaccinated_per_hundred
                        ).toFixed(20)
                      )
                    );
                  })(d.values);
              }
            });

          //append title
          d3.select("svg")
            .append("text")
            .attr("x", width2 / 2)
            .attr("y", height1 + margin.bottom)
            .attr("text-anchor", "middle")
            .text("COVID-19 Vaccinations Worldwide")
            .style("fill", "black")
            .style("font-size", 20)
            .style("font-family", "Arial Black");
        });
      });

    //append legends
    var legend = d3
      .select("svg")
      .selectAll("g.legend")
      .data(sumstat)
      .enter()
      .append("g")
      .attr("class", "legend");

    legend
      .append("circle")
      .attr("cx", width1 * 0.8)
      .attr("cy", (d, i) => i * margin.left + height1 / 2)
      .attr("r", 6)
      .style("fill", (d) => color(d.key));

    legend
      .append("text")
      .attr("x", width1 * 0.8 + margin.left)
      .attr("y", (d, i) => i * margin.left + height1 / 2 + 5)
      .text((d) => d.key);

    //append title
    d3.select("svg")
      .append("text")
      .attr("x", width1 / 2)
      .attr("y", margin.top)
      .attr("text-anchor", "middle")
      .text("COVID-19 Total Cases Worldwide")
      .style("fill", "black")
      .style("font-size", 28)
      .style("font-family", "Arial Black");

    //apend source
    d3.select("svg")
      .append("text")
      .attr("x", margin.left)
      .attr("y", height1)
      .text("Source: Data from Johns Hopkins University, July 2021")
      .style("fill", "black")
      .style("font-size", 14)
      .style("font-family", "Arial Black");
  });
</script>
